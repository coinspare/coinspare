<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin • CoinSpare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:Inter,system-ui}</style>
</head>
<body class="bg-slate-50 min-h-screen">
  <header class="border-b bg-white sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-blue-100 flex items-center justify-center font-bold text-blue-700">C</div>
        <div>
          <div class="text-lg font-bold text-blue-800">CoinSpare Admin</div>
          <div class="text-xs text-slate-400">Overview</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span id="adminWho" class="text-sm text-slate-600"></span>
        <button id="logoutBtn" class="px-3 py-1 rounded-lg border">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold text-blue-800 mb-6">Admin Panel</h1>

    <section class="mb-8">
      <h2 class="font-semibold">Registered Users</h2>
      <div class="overflow-x-auto mt-3">
        <table class="w-full bg-white rounded-lg overflow-hidden">
          <thead class="bg-blue-600 text-white"><tr><th class="px-4 py-2">Name</th><th>Email</th><th>Ref Code</th><th>Ref By</th><th>Team size</th><th>Balance</th><th>Actions</th></tr></thead>
          <tbody id="usersAdmin" class="divide-y"></tbody>
        </table>
      </div>
    </section>

    <section>
      <h2 class="font-semibold">All Trades</h2>
      <div class="overflow-x-auto mt-3">
        <table class="w-full bg-white rounded-lg overflow-hidden">
          <thead class="bg-blue-600 text-white"><tr><th class="px-4 py-2">User</th><th>Email</th><th>Asset</th><th>Amt</th><th>Date</th></tr></thead>
          <tbody id="tradesAdmin" class="divide-y"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="border-t">
    <div class="max-w-6xl mx-auto px-4 py-4 text-xs text-slate-500">© <span id="year"></span> CoinSpare</div>
  </footer>

  <script src="app.js"></script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const cur = currentUser();
    if(!cur || cur.role !== 'admin' || cur.email !== 'admin@coinspare.com'){ alert('Admin only'); location.href='login.html'; throw new Error('admin only'); }
    document.getElementById('adminWho').textContent = cur.name + ' ('+cur.email+')';

    function renderUsersAdmin(){
      const users = getAllUsers();
      const el = document.getElementById('usersAdmin');
      el.innerHTML = '';
      users.forEach(u=>{
        const teamSize = (u.team || []).length;
        const bal = u.portfolio ? '₹' + u.portfolio.balance : '-';
        el.innerHTML += `<tr>
          <td class="px-4 py-2">${u.name}</td>
          <td>${u.email}</td>
          <td>${u.refCode || '-'}</td>
          <td>${u.refBy || '-'}</td>
          <td>${teamSize}</td>
          <td>${bal}</td>
          <td class="px-4 py-2">
            <button onclick="impersonate('${u.email}')" class="px-2 py-1 text-xs rounded bg-blue-600 text-white">Impersonate</button>
            <button onclick="toggleBlock('${u.email}')" class="px-2 py-1 text-xs rounded bg-red-500 text-white">Block/Unblock</button>
          </td>
        </tr>`;
      });
    }
    renderUsersAdmin();

    function renderTradesAdmin(){
      const arr = allTradesFlatten();
      const el = document.getElementById('tradesAdmin');
      el.innerHTML = '';
      if(arr.length === 0) el.innerHTML = '<tr><td colspan="5" class="text-slate-500 py-2">No trades yet</td></tr>';
      else arr.forEach(t=>{
        el.innerHTML += `<tr><td class="px-4 py-2">${t.user}</td><td>${t.email}</td><td>${t.asset}</td><td>₹${t.amount}</td><td>${t.date}</td></tr>`;
      });
    }
    renderTradesAdmin();

    function impersonate(email){
      // set current user to this user (admin still can access admin page)
      const u = getUserByEmail(email);
      if(!u) return alert('User not found');
      setCurrentUser(u);
      alert('Impersonating ' + u.email + '. Redirecting to dashboard.');
      location.href = 'dashboard.html';
    }

    function toggleBlock(email){
      const users = getAllUsers();
      const i = users.findIndex(x=>x.email===email);
      if(i===-1) return;
      users[i].status = users[i].status === 'blocked' ? 'active' : 'blocked';
      saveAllUsers(users);
      renderUsersAdmin();
      alert('Toggled block for ' + email);
    }

    document.getElementById('logoutBtn').addEventListener('click', ()=> logoutAndRedirect('login.html'));
  </script>
</body>
</html>
