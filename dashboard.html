<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CoinSpare</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        .navbar {
            background: rgba(0, 0, 0, 0.3) !important;
        }
        .dashboard-container {
            padding: 30px 0;
        }
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .card-title {
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        .card-title i {
            margin-right: 10px;
            font-size: 1.5rem;
        }
        .referral-link {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
            word-break: break-all;
            margin-bottom: 15px;
        }
        .copy-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .copy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .team-member {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .member-info h5 {
            margin-bottom: 5px;
        }
        .member-info p {
            margin-bottom: 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }
        .member-status {
            background: rgba(40, 167, 69, 0.3);
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.85rem;
        }
        .user-info {
            display: flex;
            align-items: center;
        }
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }
        .user-details h4 {
            margin-bottom: 0;
        }
        .user-details p {
            margin-bottom: 0;
            opacity: 0.8;
        }
        .logout-btn {
            background: rgba(220, 53, 69, 0.3);
            border: none;
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .logout-btn:hover {
            background: rgba(220, 53, 69, 0.5);
        }
        .empty-state {
            text-align: center;
            padding: 30px;
            opacity: 0.7;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .wallet-balance {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .wallet-currency {
            font-size: 1.2rem;
            opacity: 0.8;
        }
        .wallet-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .wallet-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 10px;
            padding: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .wallet-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .transaction-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-info {
            display: flex;
            align-items: center;
        }
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
        }
        .transaction-icon.deposit {
            background: rgba(40, 167, 69, 0.3);
        }
        .transaction-icon.withdrawal {
            background: rgba(220, 53, 69, 0.3);
        }
        .transaction-icon.referral {
            background: rgba(255, 193, 7, 0.3);
        }
        .transaction-icon.pending {
            background: rgba(255, 193, 7, 0.3);
        }
        .transaction-details h5 {
            margin-bottom: 0;
            font-size: 1rem;
        }
        .transaction-details p {
            margin-bottom: 0;
            opacity: 0.7;
            font-size: 0.85rem;
        }
        .transaction-amount {
            font-weight: 700;
        }
        .transaction-amount.positive {
            color: #28a745;
        }
        .transaction-amount.negative {
            color: #dc3545;
        }
        .transaction-amount.pending {
            color: #ffc107;
        }
        .profile-field {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .profile-field:last-child {
            border-bottom: none;
        }
        .profile-label {
            font-weight: 600;
            opacity: 0.8;
        }
        .profile-value {
            font-weight: 500;
        }
        .team-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .stat-item {
            text-align: center;
            flex: 1;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .stat-label {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        .team-level {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 10px 15px;
            display: inline-block;
            margin-top: 5px;
        }
        .team-level-badge {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border-radius: 20px;
            padding: 3px 10px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .nav-tabs {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.7);
            border: none;
            border-bottom: 2px solid transparent;
            padding: 10px 20px;
            margin-right: 10px;
        }
        .nav-tabs .nav-link:hover {
            color: white;
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
        }
        .nav-tabs .nav-link.active {
            color: white;
            background: none;
            border-bottom: 2px solid #ff6b6b;
        }
        .tab-content {
            padding-top: 20px;
        }
        .level-indicator {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }
        .level-progress {
            flex: 1;
            height: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin: 0 15px;
        }
        .level-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ee5a24);
            width: 65%;
        }
        .deposit-modal .modal-content {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            border: none;
        }
        .deposit-modal .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .deposit-modal .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        .deposit-form {
            padding: 20px 0;
        }
        .qr-code {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 10px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .upi-id {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            font-family: monospace;
            font-size: 1.2rem;
            margin: 20px 0;
        }
        .pending-deposits {
            margin-top: 20px;
        }
        .pending-item {
            background: rgba(255, 193, 7, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .pending-info h5 {
            margin-bottom: 5px;
        }
        .pending-info p {
            margin-bottom: 0;
            opacity: 0.8;
            font-size: 0.9rem;
        }
        .pending-amount {
            font-weight: 700;
            color: #ffc107;
        }
        .pending-status {
            background: rgba(255, 193, 7, 0.3);
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 0.85rem;
        }
        .share-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        .share-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s;
            border: none;
        }
        .share-btn.whatsapp {
            background-color: #25D366;
            color: white;
        }
        .share-btn.telegram {
            background-color: #0088CC;
            color: white;
        }
        .share-btn.copy {
            background-color: #6c757d;
            color: white;
        }
        .share-btn:hover {
            transform: scale(1.1);
        }
        .withdrawal-modal .modal-content {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            border: none;
        }
        .withdrawal-modal .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .withdrawal-modal .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        .withdrawal-form {
            padding: 20px 0;
        }
        .payment-method {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .payment-method:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .payment-method.selected {
            background: rgba(255, 107, 107, 0.3);
            border: 2px solid #ff6b6b;
        }
        .payment-method-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .payment-method-desc {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="fas fa-coins me-2"></i>CoinSpare
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container dashboard-container">
        <div class="row">
            <div class="col-lg-4">
                <!-- User Info Card -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-user-circle"></i>
                        Your Profile
                    </h3>
                    <div class="user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <h4 id="userName">Loading...</h4>
                            <p id="userEmail">Loading...</p>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="profile-field">
                            <span class="profile-label">Member Since</span>
                            <span class="profile-value" id="memberSince">Loading...</span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Account Status</span>
                            <span class="profile-value">
                                <span class="member-status">Active</span>
                            </span>
                        </div>
                        <div class="profile-field">
                            <span class="profile-label">Referral Code</span>
                            <span class="profile-value" id="referralCode">Loading...</span>
                        </div>
                    </div>
                </div>

                <!-- Wallet Card -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-wallet"></i>
                        Your Wallet
                    </h3>
                    <div class="text-center">
                        <div class="wallet-balance" id="walletBalance">₹0.00</div>
                        <div class="wallet-currency">Available Balance</div>
                        <div class="level-indicator">
                            <span>Level 1</span>
                            <div class="level-progress">
                                <div class="level-progress-bar"></div>
                            </div>
                            <span>Level 2</span>
                        </div>
                    </div>
                    <div class="wallet-actions">
                        <button class="btn wallet-btn" data-bs-toggle="modal" data-bs-target="#depositModal">
                            <i class="fas fa-plus me-2"></i>Deposit
                        </button>
                        <button class="btn wallet-btn" data-bs-toggle="modal" data-bs-target="#withdrawalModal">
                            <i class="fas fa-minus me-2"></i>Withdraw
                        </button>
                    </div>
                    
                    <!-- Pending Deposits -->
                    <div class="pending-deposits">
                        <h5>Pending Deposits</h5>
                        <div id="pendingDepositsList">
                            <div class="empty-state">
                                <p>No pending deposits</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Referral Card -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-link"></i>
                        Your Referral Link
                    </h3>
                    <div class="referral-link" id="referralLink">Loading...</div>
                    <div class="share-buttons">
                        <button class="share-btn whatsapp" id="shareWhatsapp" title="Share on WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="share-btn telegram" id="shareTelegram" title="Share on Telegram">
                            <i class="fab fa-telegram-plane"></i>
                        </button>
                        <button class="share-btn copy" id="copyReferralBtn" title="Copy Link">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    <p class="mt-3 text-center">Share this link with others to build your team</p>
                </div>
            </div>

            <div class="col-lg-8">
                <!-- Team Stats Card -->
                <div class="dashboard-card">
                    <h3 class="card-title">
                        <i class="fas fa-users"></i>
                        Your Team
                    </h3>
                    <div class="team-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="directReferrals">0</div>
                            <div class="stat-label">Direct Referrals</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalTeam">0</div>
                            <div class="stat-label">Total Team</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="teamEarnings">₹0</div>
                            <div class="stat-label">Team Earnings</div>
                        </div>
                    </div>
                    <div class="team-level">
                        Team Level: Beginner
                        <span class="team-level-badge">Level 1</span>
                    </div>
                </div>

                <!-- Team Members & Transactions Tabs -->
                <div class="dashboard-card">
                    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="team-tab" data-bs-toggle="tab" data-bs-target="#team" type="button" role="tab">Team Members</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">Transactions</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="dashboardTabsContent">
                        <!-- Team Members Tab -->
                        <div class="tab-pane fade show active" id="team" role="tabpanel">
                            <div id="teamMembers">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-light" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transactions Tab -->
                        <div class="tab-pane fade" id="transactions" role="tabpanel">
                            <div id="transactionHistory">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-light" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal fade deposit-modal" id="depositModal" tabindex="-1" aria-labelledby="depositModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="depositModalLabel">Deposit Funds</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="deposit-form">
                        <p>Scan the QR code or use the UPI ID below to make a payment:</p>
                        
                        <div class="qr-code" id="qrcode"></div>
                        
                        <div class="upi-id">
                            yadav.1014@superyes
                        </div>
                        
                        <div class="mb-3">
                            <label for="depositAmount" class="form-label">Amount (₹)</label>
                            <input type="number" class="form-control" id="depositAmount" placeholder="Enter amount" min="1" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="depositNote" class="form-label">Transaction Note (Optional)</label>
                            <input type="text" class="form-control" id="depositNote" placeholder="Enter transaction note">
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            After making the payment, please submit the details below. Your deposit will be pending until approved by the admin.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn copy-btn" id="submitDepositBtn">Submit Deposit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div class="modal fade withdrawal-modal" id="withdrawalModal" tabindex="-1" aria-labelledby="withdrawalModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="withdrawalModalLabel">Withdraw Funds</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="withdrawal-form">
                        <div class="mb-3">
                            <label for="withdrawalAmount" class="form-label">Amount (₹)</label>
                            <input type="number" class="form-control" id="withdrawalAmount" placeholder="Enter amount" min="1" required>
                        </div>
                        
                        <h5 class="mb-3">Select Payment Method</h5>
                        
                        <div class="payment-method" id="upiMethod">
                            <div class="payment-method-title">UPI Transfer</div>
                            <div class="payment-method-desc">Receive funds directly to your UPI ID</div>
                        </div>
                        
                        <div class="payment-method" id="bankMethod">
                            <div class="payment-method-title">Bank Transfer</div>
                            <div class="payment-method-desc">Receive funds to your bank account</div>
                        </div>
                        
                        <div id="upiDetails" class="form-group" style="display: none;">
                            <label for="upiId" class="form-label">UPI ID</label>
                            <input type="text" class="form-control" id="upiId" placeholder="your-upi@paytm">
                        </div>
                        
                        <div id="bankDetails" class="form-group" style="display: none;">
                            <label for="accountName" class="form-label">Account Holder Name</label>
                            <input type="text" class="form-control" id="accountName" placeholder="John Doe">
                            
                            <label for="accountNumber" class="form-label">Account Number</label>
                            <input type="text" class="form-control" id="accountNumber" placeholder="1234567890">
                            
                            <label for="ifscCode" class="form-label">IFSC Code</label>
                            <input type="text" class="form-control" id="ifscCode" placeholder="ABCD0123456">
                            
                            <label for="bankName" class="form-label">Bank Name</label>
                            <input type="text" class="form-control" id="bankName" placeholder="State Bank of India">
                        </div>
                        
                        <div class="mb-3">
                            <label for="withdrawalNote" class="form-label">Note (Optional)</label>
                            <input type="text" class="form-control" id="withdrawalNote" placeholder="Enter note">
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Withdrawal requests will be processed within 24-48 hours after approval.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn copy-btn" id="submitWithdrawalBtn">Submit Withdrawal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBxIujPFlHfqgL_-fLbsoSYo3gaGf2iPHQ",
            authDomain: "sabjiwalahere.firebaseapp.com",
            projectId: "sabjiwalahere",
            storageBucket: "sabjiwalahere.firebasestorage.app",
            messagingSenderId: "418578879301",
            appId: "1:418578879301:web:56bdf323bf186cbbe1a42c",
            measurementId: "G-4DGEQXXDLG"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Check if user is logged in
        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // Load user data
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById('userName').textContent = userData.fullName;
                        document.getElementById('userEmail').textContent = userData.email;
                        
                        // Make sure referral code is displayed
                        if (userData.referralCode) {
                            document.getElementById('referralCode').textContent = userData.referralCode;
                            
                            // Format referral link
                            const referralLink = `https://coinspare.github.io/coinspare?ref=${userData.referralCode}`;
                            document.getElementById('referralLink').textContent = referralLink;
                        }
                        
                        // Format member since date
                        if (userData.createdAt) {
                            const joinDate = new Date(userData.createdAt.toDate());
                            const formattedDate = joinDate.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            });
                            document.getElementById('memberSince').textContent = formattedDate;
                        }
                        
                        // Load wallet balance
                        if (userData.walletBalance) {
                            document.getElementById('walletBalance').textContent = `₹${userData.walletBalance.toFixed(2)}`;
                        }
                        
                        // Load team members
                        loadTeamMembers(userData.teamMembers || []);
                        
                        // Update team stats
                        updateTeamStats(userData.teamMembers || []);
                        
                        // Load pending deposits
                        loadPendingDeposits(user.uid);
                        
                        // Load transaction history
                        loadTransactionHistory(user.uid);
                    } else {
                        console.log("No such document!");
                    }
                })
                .catch(error => {
                    console.error("Error getting document:", error);
                });
        });
        
        // Load team members
        function loadTeamMembers(teamMemberIds) {
            const teamContainer = document.getElementById('teamMembers');
            
            if (teamMemberIds.length === 0) {
                teamContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>You don't have any team members yet.</p>
                        <p>Share your referral link to build your team!</p>
                    </div>
                `;
                return;
            }
            
            teamContainer.innerHTML = '';
            
            teamMemberIds.forEach(memberId => {
                db.collection('users').doc(memberId).get()
                    .then(doc => {
                        if (doc.exists) {
                            const memberData = doc.data();
                            const memberElement = document.createElement('div');
                            memberElement.className = 'team-member';
                            
                            // Format join date
                            let joinDate = 'N/A';
                            if (memberData.createdAt) {
                                const date = new Date(memberData.createdAt.toDate());
                                joinDate = date.toLocaleDateString();
                            }
                            
                            // Get team size
                            const teamSize = memberData.teamMembers ? memberData.teamMembers.length : 0;
                            
                            memberElement.innerHTML = `
                                <div class="member-info">
                                    <h5>${memberData.fullName}</h5>
                                    <p>${memberData.email} • Joined: ${joinDate}</p>
                                    <p>Team Size: ${teamSize}</p>
                                </div>
                                <div class="member-status">Active</div>
                            `;
                            teamContainer.appendChild(memberElement);
                        }
                    })
                    .catch(error => {
                        console.error("Error getting team member:", error);
                    });
            });
        }
        
        // Update team stats
        function updateTeamStats(teamMemberIds) {
            // Direct referrals count
            document.getElementById('directReferrals').textContent = teamMemberIds.length;
            
            // For demo, we'll calculate total team and earnings
            // In a real app, this would be more complex with recursive team structure
            let totalTeamSize = teamMemberIds.length;
            let totalEarnings = teamMemberIds.length * 2500; // ₹2500 per direct referral
            
            // Simulate level 2 team members
            const level2TeamSize = Math.floor(teamMemberIds.length * 1.5);
            totalTeamSize += level2TeamSize;
            totalEarnings += level2TeamSize * 1000; // ₹1000 per level 2 referral
            
            document.getElementById('totalTeam').textContent = totalTeamSize;
            document.getElementById('teamEarnings').textContent = `₹${totalEarnings}`;
        }
        
        // Load pending deposits
        function loadPendingDeposits(userId) {
            const pendingContainer = document.getElementById('pendingDepositsList');
            
            db.collection('deposits')
                .where('userId', '==', userId)
                .where('status', '==', 'pending')
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        pendingContainer.innerHTML = `
                            <div class="empty-state">
                                <p>No pending deposits</p>
                            </div>
                        `;
                        return;
                    }
                    
                    pendingContainer.innerHTML = '';
                    
                    querySnapshot.forEach(doc => {
                        const depositData = doc.data();
                        const depositElement = document.createElement('div');
                        depositElement.className = 'pending-item';
                        
                        // Format date
                        const depositDate = new Date(depositData.createdAt.toDate());
                        const formattedDate = depositDate.toLocaleDateString();
                        
                        depositElement.innerHTML = `
                            <div class="pending-info">
                                <h5>Deposit #${doc.id.substring(0, 8)}</h5>
                                <p>${formattedDate} • ${depositData.note || 'No note'}</p>
                            </div>
                            <div>
                                <div class="pending-amount">₹${depositData.amount.toFixed(2)}</div>
                                <div class="pending-status">Pending</div>
                            </div>
                        `;
                        
                        pendingContainer.appendChild(depositElement);
                    });
                })
                .catch(error => {
                    console.error("Error loading pending deposits: ", error);
                });
        }
        
        // Load transaction history
        function loadTransactionHistory(userId) {
            const transactionContainer = document.getElementById('transactionHistory');
            
            // Get approved deposits
            db.collection('deposits')
                .where('userId', '==', userId)
                .where('status', '==', 'approved')
                .get()
                .then(depositsSnapshot => {
                    // Get withdrawals
                    db.collection('withdrawals')
                        .where('userId', '==', userId)
                        .get()
                        .then(withdrawalsSnapshot => {
                            // Get referral bonuses
                            db.collection('referralBonuses')
                                .where('userId', '==', userId)
                                .get()
                                .then(bonusesSnapshot => {
                                    let transactions = [];
                                    
                                    // Process deposits
                                    depositsSnapshot.forEach(doc => {
                                        const depositData = doc.data();
                                        transactions.push({
                                            id: doc.id,
                                            type: 'deposit',
                                            amount: depositData.amount,
                                            date: depositData.createdAt.toDate(),
                                            note: depositData.note || 'Deposit',
                                            status: 'approved'
                                        });
                                    });
                                    
                                    // Process withdrawals
                                    withdrawalsSnapshot.forEach(doc => {
                                        const withdrawalData = doc.data();
                                        transactions.push({
                                            id: doc.id,
                                            type: 'withdrawal',
                                            amount: withdrawalData.amount,
                                            date: withdrawalData.createdAt.toDate(),
                                            note: withdrawalData.note || 'Withdrawal',
                                            status: withdrawalData.status
                                        });
                                    });
                                    
                                    // Process bonuses
                                    bonusesSnapshot.forEach(doc => {
                                        const bonusData = doc.data();
                                        transactions.push({
                                            id: doc.id,
                                            type: 'bonus',
                                            amount: bonusData.amount,
                                            date: bonusData.createdAt.toDate(),
                                            note: bonusData.note || 'Referral Bonus',
                                            status: 'approved'
                                        });
                                    });
                                    
                                    // Sort transactions by date (newest first)
                                    transactions.sort((a, b) => b.date - a.date);
                                    
                                    // Display transactions
                                    if (transactions.length === 0) {
                                        transactionContainer.innerHTML = `
                                            <div class="empty-state">
                                                <i class="fas fa-exchange-alt"></i>
                                                <p>No transactions yet</p>
                                            </div>
                                        `;
                                        return;
                                    }
                                    
                                    transactionContainer.innerHTML = '';
                                    
                                    transactions.forEach(transaction => {
                                        const transactionElement = document.createElement('div');
                                        transactionElement.className = 'transaction-item';
                                        
                                        // Format date
                                        const formattedDate = transaction.date.toLocaleDateString();
                                        
                                        // Set icon and color based on type
                                        let iconClass, iconColor;
                                        if (transaction.type === 'deposit') {
                                            iconClass = 'fas fa-arrow-down';
                                            iconColor = 'deposit';
                                        } else if (transaction.type === 'withdrawal') {
                                            iconClass = 'fas fa-arrow-up';
                                            iconColor = 'withdrawal';
                                        } else {
                                            iconClass = 'fas fa-gift';
                                            iconColor = 'referral';
                                        }
                                        
                                        // Set amount color
                                        let amountClass;
                                        if (transaction.type === 'withdrawal') {
                                            amountClass = 'negative';
                                        } else {
                                            amountClass = 'positive';
                                        }
                                        
                                        transactionElement.innerHTML = `
                                            <div class="transaction-info">
                                                <div class="transaction-icon ${iconColor}">
                                                    <i class="${iconClass}"></i>
                                                </div>
                                                <div class="transaction-details">
                                                    <h5>${transaction.note}</h5>
                                                    <p>${formattedDate}</p>
                                                </div>
                                            </div>
                                            <div class="transaction-amount ${amountClass}">
                                                ${transaction.type === 'withdrawal' ? '-' : '+'}₹${transaction.amount.toFixed(2)}
                                            </div>
                                        `;
                                        
                                        transactionContainer.appendChild(transactionElement);
                                    });
                                });
                        });
                })
                .catch(error => {
                    console.error("Error loading transaction history: ", error);
                });
        }
        
        // Generate QR code when deposit modal is opened
        document.getElementById('depositModal').addEventListener('shown.bs.modal', function() {
            // Clear previous QR code if any
            document.getElementById('qrcode').innerHTML = '';
            
            // Generate QR code for UPI ID
            new QRCode(document.getElementById("qrcode"), {
                text: "upi://pay?pa=yadav.1014@superyes&pn=CoinSpare&am=&cu=INR",
                width: 180,
                height: 180,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        });
        
        // Copy referral link
        document.getElementById('copyReferralBtn').addEventListener('click', function() {
            const referralLink = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(referralLink)
                .then(() => {
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                });
        });
        
        // Share on WhatsApp
        document.getElementById('shareWhatsapp').addEventListener('click', function() {
            const referralLink = document.getElementById('referralLink').textContent;
            const message = `Join me on CoinSpare and start earning! Use my referral link: ${referralLink}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        });
        
        // Share on Telegram
        document.getElementById('shareTelegram').addEventListener('click', function() {
            const referralLink = document.getElementById('referralLink').textContent;
            const message = `Join me on CoinSpare and start earning! Use my referral link: ${referralLink}`;
            const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${encodeURIComponent(message)}`;
            window.open(telegramUrl, '_blank');
        });
        
        // Submit deposit
        document.getElementById('submitDepositBtn').addEventListener('click', function() {
            const amount = parseFloat(document.getElementById('depositAmount').value);
            const note = document.getElementById('depositNote').value;
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                alert('User not authenticated');
                return;
            }
            
            // Create deposit record
            db.collection('deposits').add({
                userId: user.uid,
                amount: amount,
                note: note,
                status: 'pending',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(docRef => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('depositModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('depositAmount').value = '';
                document.getElementById('depositNote').value = '';
                
                // Show success message
                alert('Deposit submitted successfully! It will be added to your wallet after admin approval.');
                
                // Reload pending deposits
                loadPendingDeposits(user.uid);
            })
            .catch(error => {
                console.error('Error submitting deposit: ', error);
                alert('Error submitting deposit. Please try again.');
            });
        });
        
        // Payment method selection for withdrawal
        document.getElementById('upiMethod').addEventListener('click', function() {
            document.getElementById('upiMethod').classList.add('selected');
            document.getElementById('bankMethod').classList.remove('selected');
            document.getElementById('upiDetails').style.display = 'block';
            document.getElementById('bankDetails').style.display = 'none';
        });
        
        document.getElementById('bankMethod').addEventListener('click', function() {
            document.getElementById('bankMethod').classList.add('selected');
            document.getElementById('upiMethod').classList.remove('selected');
            document.getElementById('bankDetails').style.display = 'block';
            document.getElementById('upiDetails').style.display = 'none';
        });
        
        // Submit withdrawal
        document.getElementById('submitWithdrawalBtn').addEventListener('click', function() {
            const amount = parseFloat(document.getElementById('withdrawalAmount').value);
            const note = document.getElementById('withdrawalNote').value;
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            const user = auth.currentUser;
            if (!user) {
                alert('User not authenticated');
                return;
            }
            
            // Check if payment method is selected
            const isUpiSelected = document.getElementById('upiMethod').classList.contains('selected');
            const isBankSelected = document.getElementById('bankMethod').classList.contains('selected');
            
            if (!isUpiSelected && !isBankSelected) {
                alert('Please select a payment method');
                return;
            }
            
            // Get payment details
            let paymentDetails = {};
            
            if (isUpiSelected) {
                const upiId = document.getElementById('upiId').value;
                if (!upiId) {
                    alert('Please enter your UPI ID');
                    return;
                }
                paymentDetails = {
                    method: 'upi',
                    upiId: upiId
                };
            } else {
                const accountName = document.getElementById('accountName').value;
                const accountNumber = document.getElementById('accountNumber').value;
                const ifscCode = document.getElementById('ifscCode').value;
                const bankName = document.getElementById('bankName').value;
                
                if (!accountName || !accountNumber || !ifscCode || !bankName) {
                    alert('Please fill all bank details');
                    return;
                }
                
                paymentDetails = {
                    method: 'bank',
                    accountName: accountName,
                    accountNumber: accountNumber,
                    ifscCode: ifscCode,
                    bankName: bankName
                };
            }
            
            // Create withdrawal record
            db.collection('withdrawals').add({
                userId: user.uid,
                amount: amount,
                note: note,
                status: 'pending',
                paymentDetails: paymentDetails,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(docRef => {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('withdrawalModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('withdrawalAmount').value = '';
                document.getElementById('withdrawalNote').value = '';
                document.getElementById('upiId').value = '';
                document.getElementById('accountName').value = '';
                document.getElementById('accountNumber').value = '';
                document.getElementById('ifscCode').value = '';
                document.getElementById('bankName').value = '';
                document.getElementById('upiMethod').classList.remove('selected');
                document.getElementById('bankMethod').classList.remove('selected');
                document.getElementById('upiDetails').style.display = 'none';
                document.getElementById('bankDetails').style.display = 'none';
                
                // Show success message
                alert('Withdrawal submitted successfully! It will be processed within 24-48 hours after approval.');
                
                // Reload transaction history
                loadTransactionHistory(user.uid);
            })
            .catch(error => {
                console.error('Error submitting withdrawal: ', error);
                alert('Error submitting withdrawal. Please try again.');
            });
        });
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            auth.signOut()
                .then(() => {
                    window.location.href = 'index.html';
                })
                .catch(error => {
                    console.error('Logout error: ', error);
                });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
